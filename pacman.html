<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°ç²¾éˆï¼šé€²éšé›£åº¦æŒ‘æˆ°ç‰ˆ</title>
    <style>
        body {
            background-color: #0d0d0d; color: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100vh; margin: 0;
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; overflow: hidden;
        }
        #ui { margin-bottom: 10px; display: flex; gap: 40px; font-size: 26px; font-weight: bold; color: #FFEB3B; }
        .stat-box { background: rgba(255,255,255,0.1); padding: 5px 20px; border-radius: 10px; border: 1px solid #333; }
        canvas { border: 4px solid #1919A6; background-color: black; box-shadow: 0 0 30px rgba(25, 25, 166, 0.4); }
        #overlay {
            position: absolute; display: none; background: rgba(0,0,0,0.95); padding: 40px;
            border: 3px solid #FFEB3B; text-align: center; z-index: 100; border-radius: 20px;
        }
        button {
            background: #FFEB3B; border: none; padding: 12px 30px; cursor: pointer;
            font-weight: bold; font-size: 20px; margin-top: 20px; border-radius: 8px; transition: 0.2s;
        }
        button:hover { background: #fff; transform: scale(1.05); }
        .hint { margin-top: 15px; color: #555; font-size: 14px; }
    </style>
</head>
<body>

    <div id="ui">
        <div class="stat-box">LEVEL: <span id="levelText">1</span></div>
        <div class="stat-box">SCORE: <span id="scoreText">0</span></div>
    </div>
    
    <div style="position: relative;">
        <canvas id="gameCanvas"></canvas>
        <div id="overlay">
            <h2 id="statusTitle" style="font-size: 40px; margin-bottom: 10px;">LEVEL CLEAR</h2>
            <p id="statusDesc" style="color: #00FFFF; margin-bottom: 20px;">å¹½éˆé€Ÿåº¦å·²æå‡ï¼</p>
            <button id="actionBtn" onclick="nextLevelOrRestart()">ç¹¼çºŒæŒ‘æˆ°</button>
        </div>
    </div>

    <div class="hint">æ¯é—œ 300/600 åˆ†æœƒå¢åŠ å¹½éˆ â€¢ å¹½éˆéš¨é—œå¡è®Šå¿«</div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreText = document.getElementById('scoreText');
        const levelText = document.getElementById('levelText');
        const overlay = document.getElementById('overlay');
        const statusTitle = document.getElementById('statusTitle');
        const statusDesc = document.getElementById('statusDesc');

        const TILE = 20;     
        const PACMAN_SPEED = 2; 

        // åœ°åœ–é…ç½® (5é—œ)
        const allLevels = [
            // Level 1: ç¶“å…¸ç‰ˆ (ç´„1080åˆ†)
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,3,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,3,1],
                [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],[1,0,0,0,0,1,0,0,0,1,2,2,2,1,0,0,0,0,1],
                [1,1,1,1,0,1,1,1,2,2,2,1,1,1,0,1,1,1,1],[2,2,2,1,0,1,2,2,2,2,2,2,2,1,0,1,2,2,2],
                [1,1,1,1,0,1,2,1,1,2,1,1,2,1,0,1,1,1,1],[1,0,0,0,0,0,0,1,2,2,2,1,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
                [1,3,0,1,1,1,1,1,0,1,0,1,1,1,1,1,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 2: åå­—è·¯å£ (ç´„960åˆ†)
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,1,0,0,0,0,2,0,0,0,0,1,0,0,0,1],
                [1,3,1,0,1,0,1,1,1,2,1,1,1,0,1,0,1,3,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,0,1,1,1,1,0,1,0,1,1,1,1,0,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,2,1,1,1,1,1,2,1,1,1,1,0,1],[1,0,1,1,1,1,2,2,2,2,2,2,2,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,1],[1,1,1,0,1,1,0,0,0,1,0,0,0,1,1,0,1,1,1],
                [1,3,0,0,0,0,1,1,0,0,0,1,1,0,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 3: çª„å··å¯†å®¤ (ç´„880åˆ†)
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,3,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,3,1],
                [1,1,0,1,0,1,1,1,1,2,1,1,1,1,0,1,0,1,1],[1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1],
                [1,0,1,1,0,1,0,1,1,2,1,1,0,1,0,1,1,0,1],[1,0,1,1,0,0,0,1,2,2,2,1,0,0,0,1,1,0,1],
                [1,0,0,0,0,1,0,1,1,1,1,1,0,1,0,0,0,0,1],[1,1,1,1,0,1,0,0,0,0,0,0,0,1,0,1,1,1,1],
                [1,0,0,0,0,1,1,1,0,1,0,1,1,1,0,0,0,0,1],[1,3,1,1,0,0,0,0,0,1,0,0,0,0,0,1,1,3,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 4: åœ“ç’°éš§é“ (ç´„1120åˆ†)
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,3,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,3,1],[1,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,1],
                [1,0,1,0,1,1,1,1,2,2,2,1,1,1,1,0,1,0,1],[1,0,1,0,1,2,2,2,2,2,2,2,2,2,1,0,1,0,1],
                [1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1],[1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            // Level 5: çµ‚æ¥µæŒ‘æˆ° (ç´„880åˆ†)
            [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,3,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,3,1],
                [1,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,2,2,2,1,1,1,1,1,1,0,1],[1,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1],
                [1,1,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,1,1],[1,0,0,0,0,0,0,1,3,0,3,1,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ]
        ];

        let currentLevelIndex = 0;
        let map = [];
        let totalScore = 0;
        let levelScore = 0; // ç•¶å‰é—œå¡å¾—åˆ†
        let milestoneReached = 0;
        let isGameOver = false;
        let powerModeTimer = 0;
        let pacman, ghosts;

        function initLevel(index) {
            map = JSON.parse(JSON.stringify(allLevels[index]));
            canvas.width = map[0].length * TILE;
            canvas.height = map.length * TILE;
            
            // å¹½éˆåˆå§‹é€Ÿåº¦éš¨é—œå¡å¢åŠ  (2.0 -> 2.15 -> 2.3 -> 2.45 -> 2.6)
            let ghostSpeed = 2 + (index * 0.15);
            
            pacman = { x: TILE, y: TILE, dirX: 0, dirY: 0, reqX: 0, reqY: 0 };
            ghosts = [
                { x: 9 * TILE, y: 5 * TILE, dirX: 0, dirY: -1, color: '#FF0000', baseColor: '#FF0000', speed: ghostSpeed, isScared: false }
            ];
            
            levelScore = 0;
            milestoneReached = 0;
            powerModeTimer = 0;
            levelText.innerText = index + 1;
            isGameOver = false;
            overlay.style.display = 'none';
        }

        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp')    { pacman.reqX = 0; pacman.reqY = -1; }
            if (e.key === 'ArrowDown')  { pacman.reqX = 0; pacman.reqY = 1; }
            if (e.key === 'ArrowLeft')  { pacman.reqX = -1; pacman.reqY = 0; }
            if (e.key === 'ArrowRight') { pacman.reqX = 1; pacman.reqY = 0; }
        });

        function isWall(px, py) {
            const gx = Math.floor(px / TILE), gy = Math.floor(py / TILE);
            if (gy < 0 || gy >= map.length || gx < 0 || gx >= map[0].length) return true;
            return map[gy][gx] === 1;
        }

        function checkGhostMilestones() {
            let ghostSpeed = 2 + (currentLevelIndex * 0.15);
            // 300åˆ†å¢åŠ ç¬¬2éš»
            if (levelScore >= 300 && milestoneReached < 300) {
                ghosts.push({ x: 9 * TILE, y: 5 * TILE, dirX: 1, dirY: 0, color: '#FFB8FF', baseColor: '#FFB8FF', speed: ghostSpeed, isScared: false });
                milestoneReached = 300;
            }
            // 600åˆ†å¢åŠ ç¬¬3éš»
            if (levelScore >= 600 && milestoneReached < 600) {
                ghosts.push({ x: 9 * TILE, y: 5 * TILE, dirX: -1, dirY: 0, color: '#00FFFF', baseColor: '#00FFFF', speed: ghostSpeed, isScared: false });
                milestoneReached = 600;
            }
        }

        function update() {
            if (isGameOver) return;

            if (powerModeTimer > 0) {
                powerModeTimer--;
                if (powerModeTimer === 0) ghosts.forEach(g => g.isScared = false);
            }

            // --- å°ç²¾éˆ ---
            if (pacman.x % TILE === 0 && pacman.y % TILE === 0) {
                const gx = pacman.x / TILE, gy = pacman.y / TILE;
                let eaten = 0;
                if (map[gy][gx] === 0) { map[gy][gx] = 2; eaten = 10; } 
                else if (map[gy][gx] === 3) { map[gy][gx] = 2; eaten = 50; powerModeTimer = 400; ghosts.forEach(g => g.isScared = true); }
                
                if (eaten > 0) {
                    totalScore += eaten;
                    levelScore += eaten;
                    scoreText.innerText = totalScore;
                    checkGhostMilestones();
                }

                if (!isWall(pacman.x + pacman.reqX * TILE, pacman.y + pacman.reqY * TILE)) {
                    pacman.dirX = pacman.reqX; pacman.dirY = pacman.reqY;
                }
                if (isWall(pacman.x + pacman.dirX * TILE, pacman.y + pacman.dirY * TILE)) {
                    pacman.dirX = 0; pacman.dirY = 0;
                }
            }
            pacman.x += pacman.dirX * PACMAN_SPEED;
            pacman.y += pacman.dirY * PACMAN_SPEED;

            // --- å¹½éˆ ---
            ghosts.forEach(g => {
                let s = g.isScared ? g.speed / 2 : g.speed;
                
                // å¹½éˆ AIï¼šåˆ°é”ç¶²æ ¼é»é™„è¿‘æ™‚æ±ºå®šæ–¹å‘
                if (Math.abs(g.x % TILE) < s && Math.abs(g.y % TILE) < s) {
                    g.x = Math.round(g.x / TILE) * TILE;
                    g.y = Math.round(g.y / TILE) * TILE;
                    const dirs = [{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];
                    let possible = dirs.filter(d => !isWall(g.x + d.x * TILE, g.y + d.y * TILE));
                    if (possible.length > 1) possible = possible.filter(d => !(d.x === -g.dirX && d.y === -g.dirY));
                    const pick = possible[Math.floor(Math.random() * possible.length)];
                    if (pick) { g.dirX = pick.x; g.dirY = pick.y; }
                }
                g.x += g.dirX * s; g.y += g.dirY * s;

                // ç¢°æ’åˆ¤å®š
                if (Math.hypot(pacman.x - g.x, pacman.y - g.y) < TILE * 0.75) {
                    if (g.isScared) {
                        g.x = 9 * TILE; g.y = 5 * TILE; g.isScared = false;
                        totalScore += 200; levelScore += 200; scoreText.innerText = totalScore;
                    } else {
                        endGame(false);
                    }
                }
            });

            // æª¢æŸ¥éé—œ (åœ°åœ–ä¸Šæ²’è±†å­)
            if (!map.some(row => row.includes(0)) && !map.some(row => row.includes(3))) endGame(true);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let r = 0; r < map.length; r++) {
                for (let c = 0; c < map[r].length; c++) {
                    if (map[r][c] === 1) {
                        ctx.fillStyle = '#1919A6'; ctx.fillRect(c * TILE + 2, r * TILE + 2, TILE - 4, TILE - 4);
                    } else if (map[r][c] === 0) {
                        ctx.fillStyle = '#FFB8AE'; ctx.beginPath(); ctx.arc(c * TILE + TILE/2, r * TILE + TILE/2, 2.5, 0, Math.PI*2); ctx.fill();
                    } else if (map[r][c] === 3) {
                        if (Math.floor(Date.now() / 200) % 2 === 0) {
                            ctx.fillStyle = '#FFB8AE'; ctx.beginPath(); ctx.arc(c * TILE + TILE/2, r * TILE + TILE/2, 6, 0, Math.PI*2); ctx.fill();
                        }
                    }
                }
            }
            // ç•«å¹½éˆ
            ghosts.forEach(g => {
                ctx.fillStyle = g.isScared ? ((powerModeTimer < 100 && Math.floor(Date.now()/100)%2===0)?'#FFF':'#2121FF') : g.baseColor;
                ctx.beginPath(); ctx.arc(g.x + TILE/2, g.y + TILE/2, TILE/2 - 2, Math.PI, 0);
                ctx.lineTo(g.x + TILE - 2, g.y + TILE - 2); ctx.lineTo(g.x + 2, g.y + TILE - 2); ctx.fill();
                ctx.fillStyle = "white"; ctx.fillRect(g.x + 5, g.y + 6, 3, 3); ctx.fillRect(g.x + 12, g.y + 6, 3, 3);
            });
            // ç•«å°ç²¾éˆ
            ctx.fillStyle = '#FFEB3B';
            ctx.beginPath();
            const mouth = Math.abs(Math.sin(Date.now() / 150)) * 0.4;
            let rot = (pacman.dirX === 1) ? 0 : (pacman.dirX === -1) ? Math.PI : (pacman.dirY === -1) ? -Math.PI/2 : Math.PI/2;
            ctx.moveTo(pacman.x + TILE/2, pacman.y + TILE/2);
            ctx.arc(pacman.x + TILE/2, pacman.y + TILE/2, TILE/2 - 1, rot + mouth, rot + (2 * Math.PI - mouth));
            ctx.fill();
        }

        function endGame(win) {
            isGameOver = true;
            if (win) {
                if (currentLevelIndex < allLevels.length - 1) {
                    statusTitle.innerText = "LEVEL " + (currentLevelIndex + 1) + " CLEAR!";
                    statusTitle.style.color = "#FFEB3B";
                    statusDesc.innerText = "ä¸‹ä¸€é—œå¹½éˆé€Ÿåº¦å°‡æå‡è‡³ " + (2 + (currentLevelIndex + 1) * 0.15).toFixed(2);
                    statusDesc.style.color = "#00FFFF";
                    actionBtn.innerText = "é€²å…¥ä¸‹ä¸€é—œ";
                } else {
                    statusTitle.innerText = "ğŸ† æœ€çµ‚å…¨ç ´é—œï¼";
                    statusTitle.style.color = "#4CAF50";
                    statusDesc.innerText = "æ­å–œä½ æˆ°å‹äº†æ‰€æœ‰çš„åœ°åœ–èˆ‡å¹½éˆï¼";
                    actionBtn.innerText = "é‡æ–°é–‹å§‹éŠæˆ²";
                }
            } else {
                statusTitle.innerText = "GAME OVER";
                statusTitle.style.color = "#FF4444";
                statusDesc.innerText = "ç¸½å¾—åˆ†: " + totalScore;
                actionBtn.innerText = "å†æŒ‘æˆ°ä¸€æ¬¡";
            }
            overlay.style.display = 'block';
        }

        function nextLevelOrRestart() {
            if (statusTitle.innerText.includes("GAME OVER") || statusTitle.innerText.includes("æœ€çµ‚å…¨ç ´")) {
                currentLevelIndex = 0; totalScore = 0; scoreText.innerText = 0;
            } else {
                currentLevelIndex++;
            }
            initLevel(currentLevelIndex);
        }

        initLevel(0);
        function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
        gameLoop();
    </script>
</body>
</html>
